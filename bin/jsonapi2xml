#!/usr/bin/perl

use strict;
use warnings;

use Mojolicious::Lite;
use Mojo::ByteStream qw(b);
use Scalar::Util qw(blessed reftype);
use Data::Plist::XMLWriter;
use Mojo::JSON qw(decode_json);
use LWP::UserAgent;

our $VERSION = '0.01';

my $ua = LWP::UserAgent->new;

get '/*url' => sub {
	my $self = shift;
	my $url  = $self->param('url');
	my $res = $ua->get( $url );
	if ( $res->is_success ) {
		my $xml = json2plist($res->decoded_content);
		$self->render(format => 'xml', data => $xml);
	}
	else {
		$self->render(text => $res->status_line, code => 500);
	}
	return;
};

app->start;

sub json2plist {
	my $json = shift;
	my $ref = decode_json(b($json)->encode);
	stringify_objects($ref);
	my $converter = Data::Plist::XMLWriter->new();
	return $converter->write($ref);
}

sub stringify_objects {
  for my $val (@_) {
    next unless my $ref = reftype $val;
    if (blessed $val) { $val = "$val" }
    elsif ($ref eq 'ARRAY') { stringify_objects(@$val) }
    elsif ($ref eq 'HASH')  { stringify_objects(values %$val) }
  }
}

=pod

=head1 NAME

jsonapi2xml - cgi to convert json api to plist

=head1 DESCRIPTION

jsonapi2xml is a simple cgi-script that converts json to a plist.

It examines its PATH_INFO to get an url for a webapi returing json:

  http://example.org/cgi-bin/jsonapi2xml/api.metacpan.org/v0/release/Moose

This will return the plist for http://api.metacpan.org/v0/release/Moose.

=head1 INSTALLATION

  perl Build.PL
  ./Build.PL install

=cut

